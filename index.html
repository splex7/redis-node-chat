<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Chat</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }

      #user-info {
        padding: 10px;
        background: #f3f3f3;
        border-bottom: 1px solid #ddd;
      }

      #chat-container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 10px;
      }

      #messages {
        flex: 1;
        overflow-y: auto;
        padding: 10px;
        border: 1px solid #ddd;
        margin-bottom: 10px;
        height: 400px; /* Fixed height */
        display: flex;
        flex-direction: column; /* Always scroll to bottom */
        max-height: 400px;
      }

      .message {
        display: flex;
        margin-bottom: 10px;
      }

      .message.sent {
        justify-content: flex-end;
      }

      .message-bubble {
        max-width: 70%;
        padding: 10px;
        border-radius: 10px;
        background: #e1ffc7;
        position: relative;
      }

      .message-bubble.sent {
        background: #d1e7ff;
      }

      .message-time {
        font-size: 0.75em;
        color: #888;
        margin-left: 10px;
        align-self: flex-end;
      }

      #message-input-container {
        display: flex;
      }

      #message-input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        margin-right: 10px;
      }

      button {
        padding: 10px 20px;
        background: #28a745;
        color: #fff;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }

      button:hover {
        background: #218838;
      }
    </style>
  </head>
  <body>
    <div id="user-info">
      <p>User ID: <span id="user-id-display"></span></p>
      <p>Created At: <span id="created-at-display"></span></p>
    </div>
    <div id="chat-container">
      <div id="messages"></div>
      <div id="message-input-container">
        <input
          type="text"
          id="message-input"
          placeholder="Enter your message"
        />
        <button onclick="sendMessage()">Send</button>
      </div>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
      let userId = sessionStorage.getItem("userId");
      if (!userId) {
        userId = "user" + Math.floor(Math.random() * 1000000);
        sessionStorage.setItem("userId", userId);
      }

      const socket = io({
        query: { userId: userId },
      });

      socket.on("welcome", (data) => {
        document.getElementById("user-id-display").innerText = data.userId;
        document.getElementById("created-at-display").innerText =
          data.createdAt;
        sessionStorage.setItem("userId", data.userId);
        sessionStorage.setItem("createdAt", data.createdAt);

        data.messages.forEach((message) => {
          const messageElement = document.createElement("div");
          messageElement.className =
            "message" + (message.userId === userId ? " sent" : "");

          const messageBubble = document.createElement("div");
          messageBubble.className =
            "message-bubble" + (message.userId === userId ? " sent" : "");
          messageBubble.textContent = `${message.userId}: ${message.message}`;

          const messageTime = document.createElement("div");
          messageTime.className = "message-time";
          const currentTime = new Date().toLocaleTimeString();
          messageTime.textContent = currentTime;

          messageElement.appendChild(messageBubble);
          messageElement.appendChild(messageTime);

          document.getElementById("messages").appendChild(messageElement);
        });

        document.getElementById("messages").scrollTop =
          document.getElementById("messages").scrollHeight;
      });

      socket.on("message", (message) => {
        const messageElement = document.createElement("div");
        messageElement.className =
          "message" + (message.userId === userId ? " sent" : "");

        console.log("message.userId", message.userId); // for debugging
        console.log("userId", userId); // for debugging

        const messageBubble = document.createElement("div");
        messageBubble.className =
          "message-bubble" + (message.userId === userId ? " sent" : "");
        messageBubble.textContent = `${message.userId}: ${message.message}`;

        const messageTime = document.createElement("div");
        messageTime.className = "message-time";
        const currentTime = new Date().toLocaleTimeString();
        messageTime.textContent = currentTime;

        messageElement.appendChild(messageBubble);
        messageElement.appendChild(messageTime);

        document.getElementById("messages").appendChild(messageElement);

        scrollToBottom();
      });

      function scrollToBottom() {
        const messagesDiv = document.getElementById("messages");
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      }

      function sendMessage() {
        const message = document.getElementById("message-input").value;
        socket.emit("message", { message: message, userId: userId });
        document.getElementById("message-input").value = "";
      }

      // Add this event listener to handle Enter key press
      document
        .getElementById("message-input")
        .addEventListener("keypress", function (event) {
          if (event.key === "Enter") {
            event.preventDefault(); // Prevent the default action of the Enter key
            sendMessage(); // Call the sendMessage function
          }
        });
    </script>
  </body>
</html>
